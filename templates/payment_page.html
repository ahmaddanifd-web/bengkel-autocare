{% extends "base.html" %}

{% block title %}Pembayaran - Bengkel AutoCare{% endblock %}

{% block content %}
<h1 class="mb-4">Halaman Pembayaran</h1>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Detail Transaksi</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Kode Transaksi:</dt>
                    <dd class="col-sm-8"><strong>{{ transaksi.kode_transaksi }}</strong></dd>

                    <dt class="col-sm-4">Total Biaya:</dt>
                    <dd class="col-sm-8"><h5 class="text-success">Rp. {{ transaksi.total_biaya|floatformat:0 }}</h5></dd>

                    <dt class="col-sm-4">Metode Pembayaran:</dt>
                    <dd class="col-sm-8">{{ transaksi.get_metode_pembayaran_display }}</dd>

                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-warning">{{ transaksi.get_status_display }}</span>
                    </dd>

                    <dt class="col-sm-4">Kadaluarsa:</dt>
                    <dd class="col-sm-8">{{ transaksi.waktu_kadaluarsa|date:"d M Y, H:i" }}</dd>
                </dl>
            </div>
        </div>

        {% if transaction_token %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Pilih Metode Pembayaran</h5>
                </div>
                <div class="card-body">
                    <p>Klik tombol di bawah untuk melanjutkan pembayaran melalui Midtrans:</p>
                    <button type="button" class="btn btn-success btn-lg w-100" id="pay-button">
                        üí≥ Bayar Sekarang
                    </button>
                </div>
            </div>

            <script src="https://app.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>
            <script>
                document.getElementById('pay-button').addEventListener('click', function () {
                    snap.pay('{{ transaction_token }}', {
                        onSuccess: function(result){
                            alert("Pembayaran berhasil!");
                            window.location.href = '/';
                        },
                        onPending: function(result){
                            alert("Menunggu pembayaran...");
                        },
                        onError: function(result){
                            alert("Pembayaran gagal!");
                        },
                        onClose: function(){
                            alert("Anda menutup popup pembayaran tanpa menyelesaikan pembayaran");
                        }
                    });
                });
            </script>
        {% else %}
            <div class="alert alert-warning mt-4">
                ‚ö†Ô∏è Token pembayaran tidak tersedia. Silakan hubungi admin.
            </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Ringkasan Booking</h5>
            </div>
            <div class="card-body">
                <p><strong>Kendaraan:</strong><br>
                   {{ transaksi.booking.kendaraan.merk }} {{ transaksi.booking.kendaraan.model }}<br>
                   <small class="text-muted">{{ transaksi.booking.kendaraan.nomor_plat }}</small>
                </p>
                <hr>
                <p><strong>Layanan:</strong><br>
                   {{ transaksi.booking.layanan.nama }}<br>
                   <small class="text-muted">{{ transaksi.booking.layanan.jenis }}</small>
                </p>
                <hr>
                <p><strong>Tanggal & Jam:</strong><br>
                   {{ transaksi.booking.tanggal_booking|date:"d M Y, H:i" }}
                </p>
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <strong>üí° Tips:</strong> Pastikan data pembayaran Anda benar sebelum mengirim.
        </div>
    </div>
</div>
{% endblock %}
